name: Build APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:   # allows manual trigger from GitHub UI

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ 1. Checkout code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4

      # â”€â”€ 2. Setup JDK 17 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # â”€â”€ 3. Generate a placeholder launcher icon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate placeholder launcher icon
        run: |
          sudo apt-get install -y imagemagick 2>/dev/null || true
          mkdir -p app/src/main/res/mipmap-hdpi
          mkdir -p app/src/main/res/mipmap-mdpi
          mkdir -p app/src/main/res/mipmap-xhdpi
          mkdir -p app/src/main/res/mipmap-xxhdpi
          mkdir -p app/src/main/res/mipmap-xxxhdpi
          # Create colored PNG icons using ImageMagick
          for size_name in "72:hdpi" "48:mdpi" "96:xhdpi" "144:xxhdpi" "192:xxxhdpi"; do
            size=$(echo $size_name | cut -d: -f1)
            dpi=$(echo $size_name | cut -d: -f2)
            convert -size ${size}x${size} \
              xc:"#1A2688" \
              -fill white \
              -font DejaVu-Sans -pointsize $((size/3)) \
              -gravity center \
              -annotate 0 "âš“" \
              "app/src/main/res/mipmap-${dpi}/ic_launcher.png" 2>/dev/null || \
            python3 -c "
import struct, zlib
def png(w,h,color):
    def chunk(t,d):
        c=zlib.crc32(t+d)&0xffffffff
        return struct.pack('>I',len(d))+t+d+struct.pack('>I',c)
    raw=b''
    for _ in range(h):
        row=b'\x00'
        for _ in range(w):
            row+=bytes(color)
        raw+=row
    return b'\x89PNG\r\n\x1a\n'+chunk(b'IHDR',struct.pack('>IIBBBBB',w,h,8,2,0,0,0))+chunk(b'IDAT',zlib.compress(raw))+chunk(b'IEND',b'')
open('app/src/main/res/mipmap-${dpi}/ic_launcher.png','wb').write(png(${size},${size},[26,38,136]))
open('app/src/main/res/mipmap-${dpi}/ic_launcher_round.png','wb').write(png(${size},${size},[26,38,136]))
"
          done
          echo "Icons generated âœ“"

      # â”€â”€ 4. Grant execute permission to gradlew â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # â”€â”€ 5. Cache Gradle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # â”€â”€ 6. Build DEBUG APK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Debug APK
        run: ./gradlew assembleDebug --no-daemon --stacktrace
        env:
          GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=false"

      # â”€â”€ 7. Rename APK with version info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Rename APK
        run: |
          mkdir -p artifacts
          cp app/build/outputs/apk/debug/app-debug.apk \
             artifacts/BattagliaNavale-v1.0-debug.apk
          echo "APK ready: BattagliaNavale-v1.0-debug.apk"

      # â”€â”€ 8. Upload APK as artifact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: BattagliaNavale-APK
          path: artifacts/BattagliaNavale-v1.0-debug.apk
          retention-days: 30

      # â”€â”€ 9. Create GitHub Release (only on push to main) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create Release
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0-build-${{ github.run_number }}
          name: "Battaglia Navale v1.0 (build ${{ github.run_number }})"
          body: |
            ## âš“ Battaglia Navale - APK Debug
            
            Build automatico dal commit `${{ github.sha }}`
            
            ### ðŸ“¥ Come installare
            1. Scarica il file `.apk` qui sotto
            2. Sul tuo Android: **Impostazioni â†’ Sicurezza â†’ Sorgenti sconosciute â†’ Attiva**
            3. Apri il file APK scaricato e installa
            
            ### ðŸŽ® Come giocare
            - Apri l'app su **due dispositivi Android** sulla stessa rete Wi-Fi
            - Connetti i dispositivi dall'app â†’ Configura â†’ Posiziona navi â†’ Gioca!
          files: artifacts/BattagliaNavale-v1.0-debug.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # â”€â”€ 10. Print summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build summary
        run: |
          echo "## âœ… Build completata!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**APK:** BattagliaNavale-v1.0-debug.apk" >> $GITHUB_STEP_SUMMARY
          echo "**Size:** $(du -sh artifacts/*.apk | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "**Scarica:** Vai su *Actions â†’ questo run â†’ Artifacts*" >> $GITHUB_STEP_SUMMARY
